<!DOCTYPE html>
<html lang="en" data-bs-theme="<%= settings.dark_mode ? 'dark' : 'light' %>">
<head>
  <meta charset="UTF-8">
  <title><%= tableName %> - SQLite3 Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="p-4">
  <div class="container mt-4 mb-3">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link" href="/">üè† Home </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/tables">üß© Tables</a>
            </li>
            <li class="nav-item">
              <a class="nav-link"  href="/table/<%= tableName %>/structure/">üìä Structure</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active"  href="/table/<%= tableName %>/">üóÑÔ∏è Data</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/table/<%= tableName %>/import-export/">üìÅ Import / Export</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">üß∞ Tools</a>
            </li>
            <li class="nav-ietm">
              <a href="/settings" class="nav-link">‚öôÔ∏è Settings</a>
            </li>
          </ul>
        </div>
  <div class="container">
    <h1>Table: <%= tableName %></h1>
    <a href="/tables" class="btn btn-secondary mb-3">‚Üê Back</a>
    <div class="table-responsive">
      <table class="table data-table table-stripped table-bordered">
        <thead>
          <tr>
            <% if (columns && columns.length > 0) { %>
              <% columns.forEach(col => { %>
                <th><%= col.name || col %></th>
              <% }) %>
            <% } %>
          </tr>
        </thead>
        <tbody>
          <% if(rows.length == 0){ %>
            <center class="fs-3">No data</center>
            <% } else{ rows.forEach(row => { %>
            <tr data-id="<%= row.id %>">
              <% for (let key in row) { %>
                <td data-col="<%= key %>"><%= row[key] %></td>
              <% } %>
              <td><button class="btn btn-outline-danger remove-row me-2">üóëÔ∏è</button> <button class="btn btn-outline-primary edit-row">‚úíÔ∏è</button> <button class="btn btn-outline-primary save-edited-row d-none">üíæ</button></td>
            </tr>
          <% }) }%>
        </tbody>
      </table>
    </div>
    <div class="mt-3 container text-end">
      <button class="btn btn-outline-primary add-data">‚ûï Add new data</button>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function(){
      const rowNum = <%- JSON.stringify(rows && rows.length > 0 ? Object.keys(rows[0]) : []) %>;
      $(document).on('click', '.add-data', function(){ 
        function makeCol(cols) {
          let html = "";

          cols.forEach(col => {
            if (col === "id") {
              html += `<td>Auto</td>`; // show placeholder for ID (autoincrement)
            } else if (col === "action") {
              html += `<td>
                        <button class="btn btn-sm btn-danger remove-row">üóëÔ∏è</button>
                      </td>`;
            } else {
              html += `<td><input class='form-control' name='${col}'></td>`;
            }
          });

          return html + ` <td><button class="btn btn-outline-danger cancel-row me-2">üóëÔ∏è</button> <button class="btn btn-outline-primary save-row">üíæ</button></td>`;
        }
        $('.data-table tbody').append(`
          <tr class='new-data'>
          ${makeCol(rowNum)}
          </tr>
        `);
      });
      $(document).on('click', '.cancel-row', function() {
          $(this).closest('tr').remove();
        });

        $(document).on('click', '.save-row', function(){
          const newRow = $(this).closest('tr');
          let rowData = {};

          newRow.find('input').each(function() {
            const name = $(this).attr('name');
            const val = $(this).val();
            rowData[name] = val;
          });

          // console.log(rowData);
             $.ajax({
              url: '/table/<%= tableName %>/insert',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({rowData}),
              success: function(res) {
                Swal.fire('‚úÖ Success', res.message, 'success').then(() => {
                  location.reload();
                });
              },
              error: function(err) {
                console.log('‚ùå Error:', err);
              }
            });
        });

        $(document).on('click', '.remove-row', function(){
          const rowId = $(this).closest('tr').data('id');

          $.ajax({
            url: '/table/<%= tableName %>/remove-row',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({rowId}),
            success: function(res){
              location.reload();
            },
            error: function(err) {
              console.log('‚ùå Error:', err);
            }
          });
        });

        $(document).on('click', '.edit-row', function(){
          const tr = $(this).closest('tr');

          tr.find('td[data-col]').each(function() {
            let val = $(this).text();
            let col = $(this).data('col');
            if(col != 'id') $(this).html(`<input class='form-control' name="${col}" value="${val}">`);
          });

          tr.find('.edit-row').addClass('d-none');
          tr.find('.save-edited-row').removeClass('d-none');
        });

        $(document).on('click', '.save-edited-row', function(){
          const tr = $(this).closest('tr');
          let rowData = {};
          const rowId = tr.data('id');

          tr.find('input').each(function(){
            rowData[$(this).attr('name')] = $(this).val();
          });

          $.ajax({
            url: '/table/<%= tableName %>/edit-row',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({rowId, ...rowData}),
            success: function(res){
              location.reload();
            },
            error: function(err) {
              console.log('‚ùå Error:', err);
            }
          });
        });
    });
  </script>
</body>
</html>
